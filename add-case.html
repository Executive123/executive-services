<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <meta name="description" content="">
      <meta name="author" content="">
      <title>CS Data - Add Service</title>
      <!-- Custom fonts for this template-->
      <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
      <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
      <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
      <script
         src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQxcHBZ1izt6OLyGRfhB5gP0dRc_xArhE&callback=initAutocomplete&libraries=places&v=weekly"
         defer
         ></script>
      <!-- Custom styles for this template-->
      <link href="css/sb-admin-2.min.css" rel="stylesheet">
      <style>
         .center {
         margin: auto;
         width: 10%;
         }
      </style>
      <script>
         var loggedInUser = JSON.parse(window.localStorage.getItem('agentData'));
         var loggedInStatus = (window.localStorage.getItem('agentStatus'));
         var selectedCase = JSON.parse(window.localStorage.getItem('selectedCase'));

         if(loggedInUser == null){
           alert("Please log in to continue");
           window.open ('login.html','_self',false)
         }


      </script>
   </head>
   <body class="bg-gradient-primary">
      <div class="container">
         <div class="card o-hidden border-0 shadow-lg my-5">
            <div class="card-body p-0">
               <!-- Nested Row within Card Body -->
               <div class="p-5">
                  <div class="text-center">
                     <h1 class="h4 text-gray-900 mb-4">Add Service!</h1>
                  </div>
                  <form class="user">
                     <div class="form-group">
                        <select class="form-control" id="customer">
                           <option value="" disabled selected>Select Customer</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <input type="date" class="form-control" id="date" placeholder="Date">
                     </div>
                     <div class="form-group">
                        <textarea class="form-control" id="emailNote" name="emailNote" rows="6" cols="50"  placeholder="Email Note"></textarea>
                     </div>
                     <div class="form-group">
                        <select class="form-control" id="agent">
                           <option value="" disabled selected>Assign Agent</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <input type="number" class="form-control" id="cost" placeholder="Cost" onchange="calculateTotal()">
                     </div>

                     <div class="form-group">
                        <input type="number" class="form-control" id="profit" placeholder="Profit" onchange="calculateTotal()">
                     </div>

                     <div class="form-group">
                        <input type="number" class="form-control" id="totalAmount" disabled placeholder="Total Amount">
                     </div>

                     <div class="form-group">
                        <select class="form-control" id="status">
                           <option value="" disabled selected>Set Status</option>
                           <option value="Open">Open</option>
                           <option value="Close">Close</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <input type="file" id="files" /><br /><br />
                        <p id="uploading"></p>
                     </div>
               </div>
               <div class="center">
               <a  href="#" onclick="validateForm()" id="registerButton"class="btn btn-primary">
               Add Service
               </a>
               </div>
               <hr>
               </form>
            </div>
         </div>
      </div>
      </div>


<script>
function calculateTotal() {
  var cost = document.getElementById("cost").value;
  if(cost == null || cost == ""){
    cost = 0;
  }

  var profit = document.getElementById("profit").value;
  if(profit == null || profit == ""){
    profit = 0;
  }

  var total = +cost + +profit;
  document.getElementById("totalAmount").value = total;
  // document.getElementById("demo").innerHTML = "You selected: " + x;
}
</script>
      <!-- Bootstrap core JavaScript-->
      <script src="vendor/jquery/jquery.min.js"></script>
      <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
      <!-- Core plugin JavaScript-->
      <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
      <!-- Custom scripts for all pages-->
      <script src="js/sb-admin-2.min.js"></script>
      <script>
         var files = [];
         document.getElementById("files").addEventListener("change", function(e) {
         files = e.target.files;
         });
      </script>
      <script>
         var imageUrl = "";
         var bannerUrl = "";
         function validateForm() {
           var tempName = "";
           var isDataValid = true;

           var customerSelected = document.getElementById('customer');
           var customerSelectedIndex = customerSelected.options[customerSelected.selectedIndex].value;

           var date = document.getElementById("date").value;
           var emailNote = document.getElementById("emailNote").value;

           var agentSelected = document.getElementById('agent');
           var agentSelectedIndex = agentSelected.options[agentSelected.selectedIndex].value;

           var statusSelected = document.getElementById('status');
           var statusValue = statusSelected.options[statusSelected.selectedIndex].value;

           var cost = document.getElementById("cost").value;
           var profit = document.getElementById("profit").value;
           var totalAmount = document.getElementById("totalAmount").value;

           if(customerSelectedIndex  == ""){
             alert("Please select customer");
             isDataValid = false;
             return;
           } else if (date == "") {
             alert("Date must be filled out");
             isDataValid = false;
             return;
           } else if (emailNote == "") {
             alert("Please enter email note");
             isDataValid = false;
             return;
           } else if (agentSelected == "") {
             alert("Please select agent");
             isDataValid = false;
             return;
           }  else if (statusValue == "") {
             alert("Please select status");
             isDataValid = false;
             return;
           }

           var currentdate = new Date();
           var datetime = currentdate.getDate() + ""
                       + (currentdate.getMonth()+1)  + ""
                       + currentdate.getFullYear() + ""
                       + currentdate.getHours() + ""
                       + currentdate.getMinutes() + ""
                       + currentdate.getSeconds();

           if (files.length != 0) {

                 //Loops through all the selected files
                 for (let i = 0; i < files.length; i++) {

                   var fileName = datetime+files[i].name;
                   tempName = fileName;
                   //create a storage reference
                   var storage = firebase.storage().ref(fileName);

                   //upload file
                   var upload = storage.put(files[i]);

                   //update progress bar
                   upload.on(
                     "state_changed",
                     function progress(snapshot) {
                       // var percentage =
                       //   (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                       document.getElementById("uploading").value = "Please wait...";
                     },

                     function error() {
                     },

                     function complete() {
                       var storage1 = firebase.storage().ref(fileName);

                             storage
                             .getDownloadURL()
                             .then(function(url) {
                             console.log(url);
                             console.log(isDataValid);
                             // alert(value);

                             if(isDataValid == false){
                               return;
                             } else {


                                                              const transactionDb = firebase.database().ref().child("deposits");
                                                              const depositDb = transactionDb.child(usersArray[customerSelectedIndex].phone);

                                                              var transaction = depositDb.push({
                                                               date: date,
                                                               totalAmount: totalAmount,
                                                               profit: profit,
                                                               cost: cost,
                                                               transactionType: "Debit"
                                                              });


                               db.push({
                                 customer: usersArray[customerSelectedIndex],
                                 date:date,
                                 emailNote:emailNote,
                                 agent: agentsArray[agentSelectedIndex],
                                 status: statusValue,
                                 fileUrl: url,
                                 cost: cost,
                                 profit: profit,
                                 totalAmount: totalAmount,
                                 transactionKey: transaction.key
                               });

                               window.open ('cases.html','_self',false)



                             }
                             })
                             .catch(function(error) {
                             console.log("error encountered");
                             });
                     }
                   );
                 }
                 } else {
                   console.log(isDataValid);
                   // alert(value);

                   if(isDataValid == false){
                     return;
                   } else {


                                                                                   const transactionDb = firebase.database().ref().child("deposits");
                                                                                   const depositDb = transactionDb.child(usersArray[customerSelectedIndex].phone);

                                                                                   var transaction = depositDb.push({
                                                                                    date: date,
                                                                                    totalAmount: totalAmount,
                                                                                    profit: profit,
                                                                                    cost: cost,
                                                                                    transactionType: "Debit"
                                                                                   });



                     db.push({
                       customer: usersArray[customerSelectedIndex],
                       date:date,
                       emailNote:emailNote,
                       agent: agentsArray[agentSelectedIndex],
                       status: statusValue,
                       cost: cost,
                       profit: profit,
                       totalAmount: totalAmount,
                       transactionKey: transaction.key

                     });

                     window.open ('cases.html','_self',false)



                   }
                 }




          }
      </script>
      <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-app.js"></script>
      <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-analytics.js"></script>
      <!-- Add Firebase products that you want to use -->
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-firestore.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-database.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-storage.js"></script>
      <script>
         // Your web app's Firebase configuration
         var firebaseConfig = {
           apiKey: "AIzaSyCxSTkPhcrwdYkYqj61tqYiC0Jet_5pOHk",
           authDomain: "eedc-e65c8.firebaseapp.com",
           databaseURL: "https://eedc-e65c8.firebaseio.com",
           projectId: "eedc-e65c8",
           storageBucket: "eedc-e65c8.appspot.com",
           messagingSenderId: "393595658709",
           appId: "1:393595658709:web:726e1c27e4b32b2cbfdd5c",
           measurementId: "G-RT3T2CXV9K"
         };
         // Initialize Firebase
         firebase.initializeApp(firebaseConfig);
         const db = firebase.database().ref().child("cases");

         const userDb = firebase.database().ref().child("users");
         var select = document.getElementById('customer');

         var usersArray = [];
         var pos = 0;
           userDb.once("value", function(snapshot) {
             snapshot.forEach(function(child) {
               var opt = document.createElement('option');
               opt.value = pos;
               opt.innerHTML = child.val().name;
               select.appendChild(opt);
               usersArray.push(child.val());
               // alert(usersArray[pos].name);
               pos++;
             });

           });


           const agentDb = firebase.database().ref().child("agents");
           var selectAgent = document.getElementById('agent');

           var agentsArray = [];
           var posAgent = 0;
             agentDb.once("value", function(snapshot) {
               snapshot.forEach(function(child) {
                 var opt = document.createElement('option');
                 opt.value = posAgent;
                 opt.innerHTML = child.val().name;

                 selectAgent.appendChild(opt);

                 var obj = child.val();
                 obj.key = child.key;
                 agentsArray.push(obj);
                 posAgent++;
               });

             });

      </script>
   </body>
</html>
